#!/bin/bash
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# WINDI SANDBOX RECONNAISSANCE + BACKUP
# Dragon Council Reference: 03022026-SANDBOX-RECON
# "Conhecer o terreno E proteger antes de construir"
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ WINDI SANDBOX RECONNAISSANCE + BACKUP"
echo "   $(date -u +%Y-%m-%dT%H:%M:%SZ)"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PHASE 1: BACKUP COMPLETO
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

BACKUP_DIR="/opt/windi/backups"
TIMESTAMP=$(date +%Y%m%d-%H%M%S)
BACKUP_NAME="pre-sandbox-${TIMESTAMP}"

echo "๐ฆ PHASE 1: CREATING BACKUP"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

mkdir -p "${BACKUP_DIR}"

echo "   Creating: ${BACKUP_DIR}/${BACKUP_NAME}.tar.gz"

# Backup completo de /opt/windi (excluindo backups anteriores)
cd /opt/windi
tar --exclude='./backups' --exclude='.git' --exclude='__pycache__' \
    -czf "${BACKUP_DIR}/${BACKUP_NAME}.tar.gz" . 2>/dev/null

if [ -f "${BACKUP_DIR}/${BACKUP_NAME}.tar.gz" ]; then
    BACKUP_SIZE=$(ls -lh "${BACKUP_DIR}/${BACKUP_NAME}.tar.gz" | awk '{print $5}')
    echo "   โ Backup criado: ${BACKUP_SIZE}"
    echo "   ๐ Local: ${BACKUP_DIR}/${BACKUP_NAME}.tar.gz"
else
    echo "   โ๏ธ Falha no backup - continuando com reconhecimento"
fi

echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PHASE 2: RECONNAISSANCE
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "๐ PHASE 2: RECONNAISSANCE"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""

echo "1๏ธโฃ ESTRUTURA /opt/windi:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
ls -la /opt/windi/
echo ""

echo "2๏ธโฃ ISP PROFILES:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if [ -d "/opt/windi/isp" ]; then
    ls -la /opt/windi/isp/
    echo ""
    echo "   Conteรบdo de cada ISP:"
    for dir in /opt/windi/isp/*/; do
        if [ -d "$dir" ]; then
            echo "   โ $dir"
            ls -la "$dir" 2>/dev/null | head -5
        fi
    done
else
    echo "   โ Diretรณrio /opt/windi/isp/ NรO EXISTE"
fi
echo ""

echo "3๏ธโฃ ENGINE DIRECTORY:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if [ -d "/opt/windi/engine" ]; then
    ls -la /opt/windi/engine/
else
    echo "   โ Diretรณrio /opt/windi/engine/ NรO EXISTE"
fi
echo ""

echo "4๏ธโฃ DATABASES (.db files):"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
DB_FILES=$(find /opt/windi -name "*.db" -type f 2>/dev/null)
if [ -n "$DB_FILES" ]; then
    echo "$DB_FILES"
    echo ""
    echo "   Tamanhos:"
    find /opt/windi -name "*.db" -type f -exec ls -lh {} \; 2>/dev/null
else
    echo "   โ Nenhum arquivo .db encontrado"
fi
echo ""

echo "5๏ธโฃ governance_levels.json:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
GOV_FILE=$(find /opt/windi -name "governance_levels.json" -type f 2>/dev/null | head -1)
if [ -n "$GOV_FILE" ]; then
    echo "   ๐ Encontrado: $GOV_FILE"
    echo "   ๐ Conteรบdo:"
    cat "$GOV_FILE" 2>/dev/null | head -50
else
    echo "   โ governance_levels.json NรO ENCONTRADO"
fi
echo ""

echo "6๏ธโฃ SERVIรOS ATIVOS (portas 8080-8089):"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
ss -tlnp 2>/dev/null | grep -E "808[0-9]" || \
netstat -tlnp 2>/dev/null | grep -E "808[0-9]" || \
echo "   Nenhum serviรงo nas portas 8080-8089"
echo ""

echo "7๏ธโฃ ESTRUTURA a4desk-editor:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
if [ -d "/opt/windi/a4desk-editor" ]; then
    ls -la /opt/windi/a4desk-editor/
else
    echo "   โ Diretรณrio a4desk-editor NรO EXISTE"
fi
echo ""

echo "8๏ธโฃ ARQUIVOS .json (maxdepth 3):"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
find /opt/windi -maxdepth 3 -name "*.json" -type f 2>/dev/null
echo ""

echo "9๏ธโฃ ARQUIVOS .py PRINCIPAIS:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
find /opt/windi -maxdepth 3 -name "*.py" -type f 2>/dev/null
echo ""

echo "๐ GIT STATUS:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
cd /opt/windi
git status --short 2>/dev/null || echo "   Nรฃo รฉ repositรณrio git"
echo ""
git log --oneline -5 2>/dev/null || echo ""
echo ""

# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
# PHASE 3: SUMMARY
# โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ RECONNAISSANCE SUMMARY"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "   Backup:     ${BACKUP_DIR}/${BACKUP_NAME}.tar.gz"
echo "   ISP Dir:    $([ -d /opt/windi/isp ] && echo 'โ EXISTS' || echo 'โ NOT FOUND')"
echo "   Engine Dir: $([ -d /opt/windi/engine ] && echo 'โ EXISTS' || echo 'โ NOT FOUND')"
echo "   Databases:  $(find /opt/windi -name '*.db' -type f 2>/dev/null | wc -l) encontrado(s)"
echo "   Gov Levels: $([ -n "$GOV_FILE" ] && echo 'โ FOUND' || echo 'โ NOT FOUND')"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "๐ RECONNAISSANCE COMPLETE"
echo "   AI processes. Human decides. WINDI guarantees."
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

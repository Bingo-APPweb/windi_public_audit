from fastapi import FastAPI, HTTPException
from brain.ledger import write_event
from brain.invariants import enforce_all, InvariantViolation
from brain.models import TrustEvent

app = FastAPI(title="WINDI Trust Bus")


@app.post("/event")
def receive_event(event: TrustEvent):
    try:
        enforce_all(event)
        write_event(event)
        return {"status": "accepted", "event_id": event.event_id}
    except InvariantViolation as e:
        raise HTTPException(status_code=403, detail=str(e))
@app.get("/health")
def health():
    return {
        "status": "ok",
        "service": "windi-brain",
        "mode": "local-only"
    }

#!/usr/bin/env python3
"""
A4 Desk BABEL - Tiptap Edition v4.7-gov
WINDI Publishing House - Torre de Babel Revertida
VERSION 4.3 - 29 JAN 2026

CHANGELOG v4.7-gov:
- Mein Profil: Modal para editar dados do usuário
- Preview antes de Einfügen
- Human Authorship Notice no PDF
"""
import os
import sys
import json
import hashlib
import sqlite3
import subprocess
import tempfile
import base64
import secrets
from io import BytesIO
import qrcode
from datetime import datetime, timezone, timedelta
sys.path.insert(0, "/opt/windi")  # Sandbox Core engine
from pathlib import Path
from functools import wraps
from flask import Flask, request, jsonify, send_file, render_template_string, send_from_directory, session

sys.path.insert(0, "/opt/windi/a4desk-editor/intent_parser")
try:
    from chat_integration import ChatIntentHandler
    INTENT_HANDLER = ChatIntentHandler()
    INTENT_PARSER_AVAILABLE = True
    print("✓ Intent Parser loaded")
except Exception as e:
    INTENT_PARSER_AVAILABLE = False
    print(f"⚠ Intent Parser not available: {e}")

# Phase 4: ISP Resolver
sys.path.insert(0, '/opt/windi/windi_agent/institutional_profiles')
try:
    from resolver import resolve_institutional_style
    ISP_RESOLVER_AVAILABLE = True
    print("✓ ISP Resolver loaded")
except Exception as e:
    ISP_RESOLVER_AVAILABLE = False
    print(f"⚠ ISP Resolver not available: {e}")

sys.path.insert(0, '/opt/windi/template_registry')

from dotenv import load_dotenv
load_dotenv('/etc/windi/secrets.env')

try:
    from api_endpoints import register_registry_endpoints
    REGISTRY_AVAILABLE = True
except ImportError as e:
    REGISTRY_AVAILABLE = False
    print(f"⚠️ Template Registry não disponível: {e}")

from flask_cors import CORS
import requests

sys.path.insert(0, '/opt/windi/templates')
try:
    from bescheid_generator import generate_bescheid_pdf, BEISPIEL_BAUGENEHMIGUNG
    BESCHEID_AVAILABLE = True
except ImportError:
    BESCHEID_AVAILABLE = False

app = Flask(__name__)
app.secret_key = os.getenv('WINDI_SECRET_KEY', secrets.token_hex(32))

@app.route('/static/<path:filename>')
def serve_static(filename):
    return send_from_directory('/opt/windi/a4desk-editor/static', filename)

if REGISTRY_AVAILABLE:
    register_registry_endpoints(app)
CORS(app)

CONFIG = {
    "port": int(os.getenv("WINDI_BABEL_PORT", 8085)),
    "actor": "a4desk-babel-tiptap",
    "domain": "document-production",
    "trust_bus": "http://127.0.0.1:8081",
    "gateway": "http://127.0.0.1:8082",
    "db_path": "/opt/windi/data/babel_documents.db",
    "session_timeout_minutes": 10,
    "session_max_hours": 8,
    "max_login_attempts": 3
}

SESSIONS = {}

def create_session(user_data):
    session_id = secrets.token_urlsafe(32)
    now = datetime.now(timezone.utc)
    SESSIONS[session_id] = {
        "user_id": user_data.get("employee_id", ""),
        "full_name": user_data.get("full_name", ""),
        "department": user_data.get("department", ""),
        "position": user_data.get("position", ""),
        "email": user_data.get("email", ""),
        "created_at": now.isoformat(),
        "last_activity": now.isoformat(),
        "expires_at": (now + timedelta(hours=CONFIG["session_max_hours"])).isoformat(),
        "ip_address": request.remote_addr,
        "user_agent": request.headers.get("User-Agent", ""),
        "reauth_count": 0,
        "actions_count": 0
    }
    return session_id

def validate_session(session_id):
    if not session_id or session_id not in SESSIONS:
        return None
    sess = SESSIONS[session_id]
    now = datetime.now(timezone.utc)
    expires_at = datetime.fromisoformat(sess["expires_at"].replace('Z', '+00:00'))
    if now > expires_at:
        del SESSIONS[session_id]
        return None
    last_activity = datetime.fromisoformat(sess["last_activity"].replace('Z', '+00:00'))
    if (now - last_activity).total_seconds() > CONFIG["session_timeout_minutes"] * 60:
        del SESSIONS[session_id]
        return None
    sess["last_activity"] = now.isoformat()
    sess["actions_count"] += 1
    return sess

def invalidate_session(session_id):
    if session_id in SESSIONS:
        del SESSIONS[session_id]
        return True
    return False

def init_db():
    os.makedirs(os.path.dirname(CONFIG["db_path"]), exist_ok=True)
    conn = sqlite3.connect(CONFIG["db_path"])
    cursor = conn.cursor()
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS documents (
            id TEXT PRIMARY KEY, title TEXT, content TEXT, content_html TEXT,
            human_fields TEXT, status TEXT DEFAULT 'draft', language TEXT DEFAULT 'de',
            receipt TEXT, user_id TEXT DEFAULT 'anonymous', created_by TEXT DEFAULT '',
            modified_by TEXT DEFAULT '', witness TEXT DEFAULT '', dragon TEXT DEFAULT 'claude',
            created_at TEXT, updated_at TEXT
        )
    """)
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS human_identities (
            id TEXT PRIMARY KEY, full_name TEXT NOT NULL, employee_id TEXT UNIQUE NOT NULL,
            department TEXT, position TEXT, email TEXT, supervisor_id TEXT, supervisor_name TEXT,
            password_hash TEXT, failed_attempts INTEGER DEFAULT 0, locked_until TEXT,
            created_at TEXT, updated_at TEXT
        )
    """)
    cursor.execute("""
        CREATE TABLE IF NOT EXISTS document_audit (
            id INTEGER PRIMARY KEY AUTOINCREMENT, document_id TEXT, session_id TEXT,
            action TEXT NOT NULL, actor_id TEXT NOT NULL, actor_name TEXT NOT NULL,
            actor_employee_id TEXT, actor_position TEXT, witness_id TEXT, witness_name TEXT,
            witness_position TEXT, old_status TEXT, new_status TEXT, content_hash TEXT,
            timestamp TEXT NOT NULL, ip_address TEXT, user_agent TEXT, notes TEXT,
            previous_hash TEXT, current_hash TEXT
        )
    """)
    for m in ["ALTER TABLE documents ADD COLUMN user_id TEXT DEFAULT 'anonymous'",
              "ALTER TABLE documents ADD COLUMN created_by TEXT DEFAULT ''",
              "ALTER TABLE documents ADD COLUMN modified_by TEXT DEFAULT ''",
              "ALTER TABLE documents ADD COLUMN witness TEXT DEFAULT ''",
              "ALTER TABLE documents ADD COLUMN dragon TEXT DEFAULT 'claude'",
              "ALTER TABLE documents ADD COLUMN content_html TEXT DEFAULT ''"]:
        try: cursor.execute(m)
        except: pass
    conn.commit()
    conn.close()
    print("✅ Database initialized")

def get_db():
    conn = sqlite3.connect(CONFIG["db_path"])
    conn.row_factory = sqlite3.Row
    return conn

init_db()

def get_last_audit_hash():
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT current_hash FROM document_audit ORDER BY id DESC LIMIT 1")
    row = cursor.fetchone()
    conn.close()
    return row["current_hash"] if row else "GENESIS"

def log_audit(doc_id, action, actor_data, session_id=None, witness_data=None, old_status=None, new_status=None, content_hash=None, notes=None):
    conn = get_db()
    cursor = conn.cursor()
    previous_hash = get_last_audit_hash()
    timestamp = datetime.now(timezone.utc).isoformat()
    hash_input = f"{doc_id}{action}{actor_data.get('id','')}{timestamp}{previous_hash}"
    current_hash = hashlib.sha256(hash_input.encode()).hexdigest()[:16]
    cursor.execute("""
        INSERT INTO document_audit (document_id, session_id, action, actor_id, actor_name, actor_employee_id, actor_position,
         witness_id, witness_name, witness_position, old_status, new_status, content_hash, timestamp, ip_address, user_agent, notes, previous_hash, current_hash)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    """, (doc_id, session_id, action, actor_data.get('id', 'unknown'), actor_data.get('name', 'Anonymous'), actor_data.get('employee_id', ''), actor_data.get('position', ''),
          witness_data.get('id', '') if witness_data else '', witness_data.get('name', '') if witness_data else '', witness_data.get('position', '') if witness_data else '',
          old_status, new_status, content_hash, timestamp, request.remote_addr if request else '', request.headers.get('User-Agent', '') if request else '', notes, previous_hash, current_hash))
    conn.commit()
    conn.close()
    return current_hash

def create_migration_audit(doc_id, doc_data):
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) as count FROM document_audit WHERE document_id = ?", (doc_id,))
    if cursor.fetchone()['count'] > 0:
        conn.close()
        return
    timestamp = datetime.now(timezone.utc).isoformat()
    previous_hash = get_last_audit_hash()
    hash_input = f"{doc_id}LEGACY_MIGRATED{timestamp}{previous_hash}"
    current_hash = hashlib.sha256(hash_input.encode()).hexdigest()[:16]
    cursor.execute("""INSERT INTO document_audit (document_id, action, actor_id, actor_name, actor_employee_id, old_status, new_status, timestamp, notes, previous_hash, current_hash)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)""", (doc_id, 'LEGACY_MIGRATED', doc_data.get('user_id', 'unknown'), doc_data.get('created_by', 'Unknown (Pre-v4)'), '', None, doc_data.get('status', 'draft'), doc_data.get('created_at', timestamp), f'Dokument migriert von v3', previous_hash, current_hash))
    conn.commit()
    conn.close()

def save_human_identity(identity_data):
    conn = get_db()
    cursor = conn.cursor()
    now = datetime.now(timezone.utc).isoformat()
    identity_id = identity_data.get('id') or f"HID-{datetime.now().strftime('%Y%m%d%H%M%S')}"
    password_hash = hashlib.sha256(identity_data['password'].encode()).hexdigest() if identity_data.get('password') else None
    cursor.execute("""INSERT OR REPLACE INTO human_identities (id, full_name, employee_id, department, position, email, supervisor_id, supervisor_name, password_hash, created_at, updated_at)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, COALESCE(?, (SELECT password_hash FROM human_identities WHERE id = ?)), COALESCE((SELECT created_at FROM human_identities WHERE id = ?), ?), ?)""",
        (identity_id, identity_data.get('full_name', ''), identity_data.get('employee_id', ''), identity_data.get('department', ''), identity_data.get('position', ''), identity_data.get('email', ''), identity_data.get('supervisor_id', ''), identity_data.get('supervisor_name', ''), password_hash, identity_id, identity_id, now, now))
    conn.commit()
    conn.close()
    return identity_id

def get_human_identity(employee_id):
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM human_identities WHERE employee_id = ?", (employee_id,))
    row = cursor.fetchone()
    conn.close()
    return dict(row) if row else None

def verify_identity(employee_id, password):
    identity = get_human_identity(employee_id)
    if not identity:
        return False, "Mitarbeiter nicht gefunden"
    if identity.get('locked_until'):
        locked_until = datetime.fromisoformat(identity['locked_until'].replace('Z', '+00:00'))
        if datetime.now(timezone.utc) < locked_until:
            return False, "Konto gesperrt"
    password_hash = hashlib.sha256(password.encode()).hexdigest()
    if identity.get('password_hash') != password_hash:
        conn = get_db()
        cursor = conn.cursor()
        new_attempts = (identity.get('failed_attempts', 0) or 0) + 1
        if new_attempts >= CONFIG["max_login_attempts"]:
            locked_until = (datetime.now(timezone.utc) + timedelta(minutes=15)).isoformat()
            cursor.execute("UPDATE human_identities SET failed_attempts = ?, locked_until = ? WHERE employee_id = ?", (new_attempts, locked_until, employee_id))
        else:
            cursor.execute("UPDATE human_identities SET failed_attempts = ? WHERE employee_id = ?", (new_attempts, employee_id))
        conn.commit()
        conn.close()
        return False, f"Falsches Passwort. Versuch {new_attempts}/{CONFIG['max_login_attempts']}"
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("UPDATE human_identities SET failed_attempts = 0, locked_until = NULL WHERE employee_id = ?", (employee_id,))
    conn.commit()
    conn.close()
    return True, identity

@app.route('/api/migrate/claim-documents', methods=['POST'])
def claim_legacy_documents():
    data = request.json or {}
    old_user_id, new_employee_id, new_user_name = data.get('old_user_id', ''), data.get('new_employee_id', ''), data.get('new_user_name', '')
    if not old_user_id or not new_employee_id or old_user_id == new_employee_id:
        return jsonify({"migrated": 0})
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) as count FROM documents WHERE user_id = ?", (old_user_id,))
    count = cursor.fetchone()['count']
    if count == 0:
        conn.close()
        return jsonify({"migrated": 0})
    cursor.execute("SELECT * FROM documents WHERE user_id = ?", (old_user_id,))
    docs = cursor.fetchall()
    cursor.execute("UPDATE documents SET user_id = ?, modified_by = ? WHERE user_id = ?", (new_employee_id, f'MIGRATION von {old_user_id}', old_user_id))
    conn.commit()
    conn.close()
    for doc in docs:
        create_migration_audit(doc['id'], dict(doc))
    log_audit('SYSTEM', 'DOCS_MIGRATED', {'id': new_employee_id, 'name': new_user_name, 'employee_id': new_employee_id}, notes=f'{count} Dokumente migriert')
    return jsonify({"migrated": count, "message": f"{count} Dokumente migriert"})

TRANSLATIONS = {
    "de": {"principle": "KI verarbeitet. Der Mensch entscheidet. WINDI garantiert.", "title": "Neues Dokument", "draft": "Entwurf", "validated": "Validiert", "finalized": "Abgeschlossen", "witness_required": "Prüfer erforderlich"},
    "en": {"principle": "AI processes. Human decides. WINDI guarantees.", "title": "New Document", "draft": "Draft", "validated": "Validated", "finalized": "Finalized", "witness_required": "Witness required"},
    "pt": {"principle": "IA processa. Humano decide. WINDI garante.", "title": "Novo Documento", "draft": "Rascunho", "validated": "Validado", "finalized": "Finalizado", "witness_required": "Testemunha necessária"}
}

def t(key, lang):
    return TRANSLATIONS.get(lang, {}).get(key) or TRANSLATIONS.get('de', {}).get(key) or key

def make_receipt(doc_id, content, lang, author_data=None, witness_data=None):
    ts = datetime.now(timezone.utc)
    h = hashlib.sha256(json.dumps(content, ensure_ascii=False).encode()).hexdigest()[:12]
    receipt = {"receipt_id": f"WINDI-BABEL-{ts.strftime('%d%b%y').upper()}-{h.upper()}", "document_id": doc_id, "timestamp": ts.isoformat(), "hash": h, "guardrails": ["G1", "G2", "G6", "G7", "G8"], "language": lang, "principle": t("principle", lang)}
    if author_data:
        receipt["author"] = {"name": author_data.get('name', ''), "employee_id": author_data.get('employee_id', ''), "position": author_data.get('position', '')}
    if witness_data:
        receipt["witness"] = {"name": witness_data.get('name', ''), "employee_id": witness_data.get('id', ''), "position": witness_data.get('position', ''), "relation": witness_data.get('relation', '')}
    return receipt

def generate_qr_base64(data):
    qr = qrcode.QRCode(version=1, box_size=4, border=2)
    qr.add_data(data)
    qr.make(fit=True)
    img = qr.make_image(fill_color="black", back_color="white")
    buffer = BytesIO()
    img.save(buffer, format='PNG')
    return base64.b64encode(buffer.getvalue()).decode()

@app.route('/api/health')
def health():
    return jsonify({"status": "healthy", "service": "A4 Desk BABEL v4.7-gov", "version": "4.6", "compliance": ["EU AI Act", "BSI", "DSGVO"]})

@app.route('/api/auth/login', methods=['POST'])
def api_login():
    data = request.json or {}
    employee_id, password = data.get('employee_id', ''), data.get('password', '')
    provided_name = data.get('full_name', '').strip()
    identity = get_human_identity(employee_id)
    if not identity:
        save_human_identity({'employee_id': employee_id, 'full_name': provided_name, 'department': data.get('department', ''), 'position': data.get('position', ''), 'email': data.get('email', ''), 'supervisor_id': data.get('supervisor_id', ''), 'supervisor_name': data.get('supervisor_name', ''), 'password': password})
        identity = get_human_identity(employee_id)
    elif identity.get('password_hash'):
        success, result = verify_identity(employee_id, password)
        if not success:
            log_audit(None, 'LOGIN_FAILED', {'id': employee_id, 'name': ''}, notes=result)
            return jsonify({"error": result}), 401
        stored_name = identity.get('full_name', '').strip()
        if provided_name and stored_name and provided_name.lower() != stored_name.lower():
            log_audit(None, 'LOGIN_FAILED', {'id': employee_id, 'name': provided_name}, notes=f"Name mismatch: provided '{provided_name}' != stored '{stored_name}'")
            return jsonify({"error": "Name stimmt nicht mit registriertem Namen überein"}), 401
    session_id = create_session(identity)
    log_audit(None, 'LOGIN_SUCCESS', {'id': identity['employee_id'], 'name': identity['full_name'], 'employee_id': identity['employee_id']}, session_id=session_id)
    return jsonify({"success": True, "session_id": session_id, "user": {"employee_id": identity['employee_id'], "full_name": identity['full_name'], "department": identity.get('department', ''), "position": identity.get('position', ''), "email": identity.get('email', ''), "supervisor_id": identity.get('supervisor_id', ''), "supervisor_name": identity.get('supervisor_name', '')}, "expires_in": CONFIG["session_timeout_minutes"] * 60})

@app.route('/api/auth/logout', methods=['POST'])
def api_logout():
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    if sess:
        log_audit(None, 'LOGOUT', {'id': sess['user_id'], 'name': sess['full_name'], 'employee_id': sess['user_id']}, session_id=session_id)
        invalidate_session(session_id)
    return jsonify({"success": True})

@app.route('/api/auth/validate', methods=['GET'])
def api_validate_session():
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    if not sess:
        return jsonify({"valid": False}), 401
    return jsonify({"valid": True, "user": {"employee_id": sess['user_id'], "full_name": sess['full_name']}, "remaining_seconds": CONFIG["session_timeout_minutes"] * 60})

@app.route('/api/auth/reauth', methods=['POST'])
def api_reauth():
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    if not sess:
        return jsonify({"error": "Session expired"}), 401
    data = request.json or {}
    success, result = verify_identity(sess['user_id'], data.get('password', ''))
    if success:
        sess['reauth_count'] += 1
        log_audit(None, 'REAUTH_SUCCESS', {'id': sess['user_id'], 'name': sess['full_name'], 'employee_id': sess['user_id']}, session_id=session_id, notes=f"Action: {data.get('action', '')}")
        return jsonify({"success": True})
    log_audit(None, 'REAUTH_FAILED', {'id': sess['user_id'], 'name': sess['full_name'], 'employee_id': sess['user_id']}, session_id=session_id)
    return jsonify({"error": result}), 401

# ============================================
# v4.7-gov NEW: Profile Update Endpoint
# ============================================
@app.route('/api/auth/profile', methods=['PUT'])
def api_update_profile():
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    if not sess:
        return jsonify({"error": "Session expired"}), 401
    
    data = request.json or {}
    employee_id = sess['user_id']
    
    conn = get_db()
    cursor = conn.cursor()
    now = datetime.now(timezone.utc).isoformat()
    
    cursor.execute("""
        UPDATE human_identities 
        SET department = ?, position = ?, email = ?, 
            supervisor_id = ?, supervisor_name = ?, updated_at = ?
        WHERE employee_id = ?
    """, (
        data.get('department', sess.get('department', '')),
        data.get('position', sess.get('position', '')),
        data.get('email', sess.get('email', '')),
        data.get('supervisor_id', ''),
        data.get('supervisor_name', ''),
        now,
        employee_id
    ))
    conn.commit()
    conn.close()
    
    sess['department'] = data.get('department', sess.get('department', ''))
    sess['position'] = data.get('position', sess.get('position', ''))
    sess['email'] = data.get('email', sess.get('email', ''))
    
    log_audit(None, 'PROFILE_UPDATED', {
        'id': employee_id, 
        'name': sess['full_name'], 
        'employee_id': employee_id
    }, session_id=session_id)
    
    return jsonify({
        "success": True, 
        "message": "Profil aktualisiert",
        "user": {
            "employee_id": employee_id,
            "full_name": sess['full_name'],
            "department": sess['department'],
            "position": sess['position'],
            "email": sess['email']
        }
    })

@app.route('/api/auth/profile', methods=['GET'])
def api_get_profile():
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    if not sess:
        return jsonify({"error": "Session expired"}), 401
    
    identity = get_human_identity(sess['user_id'])
    if not identity:
        return jsonify({"error": "User not found"}), 404
    
    return jsonify({
        "employee_id": identity['employee_id'],
        "full_name": identity['full_name'],
        "department": identity.get('department', ''),
        "position": identity.get('position', ''),
        "email": identity.get('email', ''),
        "supervisor_id": identity.get('supervisor_id', ''),
        "supervisor_name": identity.get('supervisor_name', ''),
        "created_at": identity.get('created_at', '')
    })

@app.route('/api/document', methods=['POST'])
def create_document():
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    data = request.json or {}
    lang = data.get('language', 'de')
    user_id = sess['user_id'] if sess else data.get('user_id', 'anonymous')
    created_by = sess['full_name'] if sess else data.get('created_by', '')
    author_data = {'id': user_id, 'name': created_by, 'employee_id': user_id, 'department': sess.get('department', '') if sess else '', 'position': sess.get('position', '') if sess else ''}
    now = datetime.now(timezone.utc).isoformat()
    doc_id = f"BABEL-{datetime.now().strftime('%Y%m%d%H%M%S')}"
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("INSERT INTO documents (id, title, content, content_html, human_fields, status, language, created_at, updated_at, user_id, created_by, dragon) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)", (doc_id, t("title", lang), "", "", "{}", "draft", lang, now, now, user_id, created_by, "claude"))
    conn.commit()
    conn.close()
    log_audit(doc_id, 'DOC_CREATED', author_data, session_id=session_id, new_status='draft')
    return jsonify({"id": doc_id, "title": t("title", lang), "status": "draft", "language": lang}), 201

@app.route('/api/document/<doc_id>', methods=['GET'])
def get_document(doc_id):
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM documents WHERE id = ?", (doc_id,))
    row = cursor.fetchone()
    conn.close()
    if not row:
        return jsonify({"error": "Not found"}), 404
    create_migration_audit(doc_id, dict(row))
    return jsonify({"id": row["id"], "title": row["title"], "content": {"text": row["content"], "html": row["content_html"] if "content_html" in row.keys() else ""}, "human_fields": json.loads(row["human_fields"] or "{}"), "status": row["status"], "language": row["language"], "receipt": json.loads(row["receipt"]) if row["receipt"] else None, "created_at": row["created_at"], "updated_at": row["updated_at"], "created_by": row["created_by"] if "created_by" in row.keys() else "", "witness": json.loads(row["witness"]) if row["witness"] else None})

@app.route('/api/document/<doc_id>', methods=['PUT'])
def update_document(doc_id):
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM documents WHERE id = ?", (doc_id,))
    row = cursor.fetchone()
    if not row:
        conn.close()
        return jsonify({"error": "Not found"}), 404
    data = request.json or {}
    title = data.get('title', row["title"])
    content_data = data.get('content', {})
    if isinstance(content_data, str):
        content_data = {"text": content_data, "html": ""}
    content = content_data.get('text', row["content"])
    content_html = content_data.get('html', '')
    human_fields = json.dumps(data.get('human_fields', json.loads(row["human_fields"] or "{}")))
    modified_by = sess['full_name'] if sess else data.get('modified_by', '')
    author_data = {'id': sess['user_id'] if sess else 'unknown', 'name': modified_by, 'employee_id': sess['user_id'] if sess else '', 'position': sess.get('position', '') if sess else ''}
    witness_data = data.get('witness_data', {})
    old_status = row["status"]
    now = datetime.now(timezone.utc).isoformat()
    content_hash = hashlib.sha256(content.encode()).hexdigest()[:12]
    cursor.execute("UPDATE documents SET title = ?, content = ?, content_html = ?, human_fields = ?, status = 'validated', updated_at = ?, modified_by = ?, witness = ? WHERE id = ?", (title, content, content_html, human_fields, now, modified_by, json.dumps(witness_data) if witness_data else '', doc_id))
    conn.commit()
    conn.close()
    log_audit(doc_id, 'DOC_UPDATED', author_data, session_id=session_id, witness_data=witness_data if witness_data.get('name') else None, old_status=old_status, new_status='validated', content_hash=content_hash)
    return jsonify({"id": doc_id, "status": "validated", "message": "Gespeichert"})

@app.route('/api/document/<doc_id>/finalize', methods=['POST'])
def finalize_document(doc_id):
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    data = request.json or {}
    witness_data = data.get('witness_data', {})
    if not witness_data.get('name'):
        return jsonify({"error": "Prüfer erforderlich", "message": t("witness_required", data.get('language', 'de'))}), 400
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM documents WHERE id = ?", (doc_id,))
    row = cursor.fetchone()
    if not row:
        conn.close()
        return jsonify({"error": "Not found"}), 404
    author_data = {'id': sess['user_id'] if sess else '', 'name': sess['full_name'] if sess else '', 'employee_id': sess['user_id'] if sess else '', 'department': sess.get('department', '') if sess else '', 'position': sess.get('position', '') if sess else ''}
    old_status = row["status"]
    content = {"text": row["content"], "human_fields": json.loads(row["human_fields"] or "{}"), "author": author_data, "witness": witness_data}
    receipt = make_receipt(doc_id, content, row["language"], author_data, witness_data)
    now = datetime.now(timezone.utc).isoformat()
    content_hash = hashlib.sha256(row["content"].encode()).hexdigest()[:12]
    cursor.execute("UPDATE documents SET status = 'finalized', receipt = ?, updated_at = ?, witness = ? WHERE id = ?", (json.dumps(receipt), now, json.dumps(witness_data), doc_id))
    conn.commit()
    conn.close()
    log_audit(doc_id, 'DOC_FINALIZED', author_data, session_id=session_id, witness_data=witness_data, old_status=old_status, new_status='finalized', content_hash=content_hash, notes=f'WINDI-QUITTUNG: {receipt["receipt_id"]}')
    return jsonify({"id": doc_id, "status": "finalized", "receipt": receipt})

@app.route('/api/document/<doc_id>', methods=['DELETE'])
def delete_document(doc_id):
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    author_data = {'id': sess['user_id'] if sess else 'unknown', 'name': sess['full_name'] if sess else 'Anonymous', 'employee_id': sess['user_id'] if sess else ''}
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT status FROM documents WHERE id = ?", (doc_id,))
    row = cursor.fetchone()
    old_status = row["status"] if row else None
    cursor.execute("DELETE FROM documents WHERE id = ?", (doc_id,))
    conn.commit()
    deleted = cursor.rowcount > 0
    conn.close()
    if deleted:
        log_audit(doc_id, 'DOC_DELETED', author_data, session_id=session_id, old_status=old_status)
        return jsonify({"success": True})
    return jsonify({"error": "Not found"}), 404

@app.route('/api/documents', methods=['GET'])
def list_documents():
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    user_id = sess['user_id'] if sess else request.args.get('user_id', 'anonymous')
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT id, title, status, language, created_at, updated_at FROM documents WHERE user_id = ? ORDER BY updated_at DESC", (user_id,))
    rows = cursor.fetchall()
    conn.close()
    return jsonify({"documents": [dict(r) for r in rows]})

@app.route('/api/document/<doc_id>/audit', methods=['GET'])
def get_document_audit(doc_id):
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM document_audit WHERE document_id = ? ORDER BY timestamp DESC", (doc_id,))
    rows = cursor.fetchall()
    conn.close()
    return jsonify({"document_id": doc_id, "audit_trail": [dict(r) for r in rows]})

@app.route('/api/verify/<receipt_id>', methods=['GET'])
def verify_receipt(receipt_id):
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM documents WHERE receipt LIKE ?", (f'%{receipt_id}%',))
    row = cursor.fetchone()
    if not row:
        conn.close()
        return jsonify({"verified": False, "error": "Receipt not found"}), 404
    
    # Fetch governance audit data
    cursor.execute("SELECT * FROM governance_audit WHERE receipt_id = ? ORDER BY id DESC LIMIT 1", (receipt_id,))
    audit_row = cursor.fetchone()
    conn.close()
    
    governance_data = None
    if audit_row:
        governance_data = {
            "human_authored_percentage": audit_row["human_authored_percentage"],
            "ai_assisted_blocks": audit_row["ai_assisted_blocks"],
            "total_blocks": audit_row["total_blocks"],
            "structure_valid": bool(audit_row["structure_valid"]),
            "template_id": audit_row["template_id"],
            "audit_timestamp": audit_row["timestamp"]
        }
        # Phase 4: Add ISP data if available
        if "institutional_profile_id" in audit_row.keys() and audit_row["institutional_profile_id"]:
            governance_data["institutional_profile"] = {
                "profile_id": audit_row["institutional_profile_id"],
                "profile_type": audit_row["institutional_profile_type"]
            }
    
    return jsonify({
        "verified": True,
        "document_id": row["id"],
        "title": row["title"],
        "status": row["status"],
        "receipt": json.loads(row["receipt"]) if row["receipt"] else {},
        "governance": governance_data,
        "principle": "KI verarbeitet. Mensch entscheidet. WINDI garantiert."
    })

@app.route('/api/users', methods=['GET'])
def list_users():
    session_id = request.headers.get('X-Session-ID', '')
    sess = validate_session(session_id)
    if not sess:
        return jsonify({"error": "Unauthorized"}), 401
    
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT employee_id, full_name, department, position FROM human_identities ORDER BY full_name")
    rows = cursor.fetchall()
    conn.close()
    return jsonify({"users": [dict(r) for r in rows]})

def sanitize_content_html(html):
    """Remove governança duplicada e metaconversa LLM - v3 FINAL"""
    import re
    if not html:
        return ""
    # 1. Frases EXATAS para remover (replace simples)
    exact_remove = [
        'Human decides. I structure.',
        'KI verarbeitet. Mensch entscheidet. WINDI garantiert.',
        '**',
    ]
    for phrase in exact_remove:
        html = html.replace(phrase, '')
    # 2. Linhas INTEIRAS contendo frases de sistema (regex por linha)
    line_patterns = [
        'WINDI Publishing House',
        'EU AI Act Compliant',
        'A4 Desk BABEL',
        'WINDI-QUITTUNG',
        'Human Authorship',
        'menschlichen Autoren erstellt',
    ]
    for pattern in line_patterns:
        html = re.sub(rf'[^<]*{re.escape(pattern)}[^<]*(<br\s*/?>|$)', '', html, flags=re.IGNORECASE)
    # 3. Divs de governança estruturados
    html = re.sub(r'<div[^>]*class="[^"]*human-authorship[^"]*"[^>]*>.*?</div>', '', html, flags=re.DOTALL)
    html = re.sub(r'<div[^>]*class="[^"]*governance[^"]*"[^>]*>.*?</div>', '', html, flags=re.DOTALL)
    # 4. Comentários/feedback do LLM (frases descritivas no final)
    llm_feedback = [
        r'[A-Z][a-zäöü]+es [^<]*Memo[^<]*erstellt[^<]*\.?',
        r'[A-Z][a-zäöü]+er [^<]*erstellt[^<]*\.?',
        r'Soll ich [^<]*\?',
        r'Möchten Sie [^<]*\?',
        r'Entspricht das [^<]*\?',
        r'Benötigen Sie [^<]*\?',
    ]
    for pattern in llm_feedback:
        html = re.sub(pattern, '', html, flags=re.IGNORECASE)
    # 5. Limpar resíduos
    html = re.sub(r'(<br\s*/?>\s*){3,}', '<br><br>', html)
    html = re.sub(r'^(\s*<br\s*/?>\s*)+', '', html)
    html = re.sub(r'(\s*<br\s*/?>\s*)+$', '', html)
    html = re.sub(r'\*\*\s*', '', html)  # asteriscos soltos
    html = re.sub(r'v4\.[0-9]+\s*', '', html)  # versões soltas
    return html.strip()

@app.route('/api/document/<doc_id>/export/<fmt>', methods=['GET'])
def export_document(doc_id, fmt):
    conn = get_db()
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM documents WHERE id = ?", (doc_id,))
    row = cursor.fetchone()
    conn.close()
    if not row:
        return jsonify({"error": "Not found"}), 404
    if fmt not in ['docx', 'pdf', 'odt', 'rtf', 'html', 'md']:
        return jsonify({"error": "Format not supported"}), 400
    title = row["title"]
    content_html = sanitize_content_html(row["content_html"] if "content_html" in row.keys() else row["content"].replace('\n', '<br>'))
    receipt_data = json.loads(row["receipt"]) if row["receipt"] else {}
    receipt_id = receipt_data.get("receipt_id", doc_id)
    receipt_hash = receipt_data.get("hash", "---")
    author_info = receipt_data.get("author", {})
    witness_info = receipt_data.get("witness", {})
    qr_base64 = generate_qr_base64(f"WINDI:{receipt_id}|{receipt_hash}")
    # ========== PHASE 3: GOVERNANCE ==========
    from governance_phase3 import extract_block_governance, validate_structure, extract_blocks_from_html, build_governance_ledger_html, save_governance_audit
    doc_metadata = json.loads(row["metadata"]) if "metadata" in row.keys() and row["metadata"] else {}
    document_blocks = doc_metadata.get("document_structure", [])
    template_id = doc_metadata.get("template_id", "unknown")
    if not document_blocks:
        document_blocks = extract_blocks_from_html(content_html)
    governance_stats = extract_block_governance(document_blocks)
    structure_check = validate_structure(document_blocks, template_id)
    governance_ledger_html = build_governance_ledger_html(governance_stats, structure_check, template_id)
    # Phase 4: Get ISP from document metadata if available
    institutional_profile = doc_metadata.get("institutional_profile")
    save_governance_audit(get_db, doc_id, governance_stats, structure_check, receipt_id, institutional_profile)
    # ========== END PHASE 3 ==========
    # v4.7-gov: Human Authorship Notice
    human_authorship_notice = """
    <div style="background:#f0fdf4;border:2px solid #059669;border-radius:8px;padding:12px;margin:20pt 0;text-align:center">
        <div style="font-size:11pt;font-weight:bold;color:#065f46">✍️ HUMAN AUTHORSHIP NOTICE</div>
        <div style="font-size:9pt;color:#047857;margin-top:6px">
            This document was created and reviewed by human authors.<br>
            AI assistance was used under human supervision and control.<br>
            Final decisions and content approval: Human responsibility.
        </div>
        <div style="font-size:8pt;color:#059669;margin-top:8px;font-style:italic">
            KI verarbeitet. Mensch entscheidet. WINDI garantiert.
        </div>
    </div>
    """
    
    html_content = f'''<!DOCTYPE html><html><head><meta charset="UTF-8"><title>{title}</title><style>body{{font-family:Helvetica,Arial,sans-serif;font-size:11pt;line-height:1.6;margin:25mm 20mm}}h1{{font-size:18pt;color:#1a365d;border-bottom:2px solid #3182ce;padding-bottom:8pt}}.footer{{margin-top:40pt;border-top:2pt solid #0d9488;padding-top:15pt}}</style></head><body><h1>{title}</h1><div>{content_html}</div>{human_authorship_notice if "HUMAN AUTHORSHIP" not in content_html and "menschlichen Autoren" not in content_html else ""}{governance_ledger_html}<div class="footer"><div style="font-size:10pt;color:#0d9488;font-weight:bold">WINDI Publishing House</div><div style="font-size:8pt">WINDI-QUITTUNG: {receipt_id} | Hash: {receipt_hash}</div><div style="font-size:8pt">Autor: {author_info.get("name","-")} ({author_info.get("employee_id","-")}) | Prüfer: {witness_info.get("name","-")} ({witness_info.get("employee_id","-")})</div><img src="data:image/png;base64,{qr_base64}" style="width:60px;margin-top:10px"/><div style="font-size:7pt;color:#718096;margin-top:5px">A4 Desk BABEL v4.7-gov | EU AI Act Compliant</div></div></body></html>'''
    with tempfile.NamedTemporaryFile(mode='w', suffix='.html', delete=False, encoding='utf-8') as f:
        f.write(html_content)
        html_path = f.name
    try:
        if fmt == 'html':
            return send_file(html_path, as_attachment=True, download_name=f"{title}.html")
        output_path = html_path.replace('.html', f'.{fmt}')
        if fmt == 'pdf':
            subprocess.run(['wkhtmltopdf', '--encoding', 'UTF-8', '--quiet', html_path, output_path], capture_output=True)
        else:
            subprocess.run(['pandoc', '-f', 'html', '-t', 'markdown' if fmt == 'md' else fmt, '-o', output_path, html_path], capture_output=True)
        mime_types = {'docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'pdf': 'application/pdf', 'odt': 'application/vnd.oasis.opendocument.text', 'rtf': 'application/rtf', 'md': 'text/markdown'}
        return send_file(output_path, as_attachment=True, download_name=f"{title}.{fmt}", mimetype=mime_types.get(fmt, 'application/octet-stream'))
    finally:
        if os.path.exists(html_path):
            os.unlink(html_path)

@app.route('/api/chat', methods=['POST'])
def chat():
    data = request.json or {}
    message, context, dragon = data.get('message', ''), data.get('context', ''), data.get('dragon', 'claude')
    # Phase 4: ISP Resolution
    isp_profile = None
    if ISP_RESOLVER_AVAILABLE:
        isp_profile = resolve_institutional_style(message)
    if INTENT_PARSER_AVAILABLE:
        intent_result = INTENT_HANDLER.handle_message(message, request.remote_addr)
        if intent_result['handled']:
            return jsonify(intent_result)
    try:
        payload = {"message": message, "context": context, "dragon": dragon, "lang": data.get("lang", "de")}
        if isp_profile:
            payload["institutional_profile"] = isp_profile
        resp = requests.post(f"{CONFIG['gateway']}/api/chat", json=payload, timeout=60)
        return jsonify(resp.json())
    except:
        return jsonify({"error": "Gateway error"}), 503

# ═══════════════════════════════════════════════════════════════════════════════
# SANDBOX CORE - Three Dragons Deliberation
# "AI processes. Human decides. WINDI guarantees."
# ═══════════════════════════════════════════════════════════════════════════════

@app.route('/api/deliberate', methods=['POST'])
def deliberate():
    """
    Endpoint de deliberação multi-agente.
    Consulta ARCHITECT (GPT), GUARDIAN (Claude), WITNESS (Gemini).
    Retorna FRAME para decisão humana.
    """
    data = request.json or {}
    user_request = data.get('request', '')
    context = data.get('context', {})
    
    if not user_request:
        return jsonify({"error": "Request is required"}), 400
    
    try:
        from engine.sandbox_core import SandboxCore
        core = SandboxCore()
        frame = core.deliberate(user_request, context)
        
        return jsonify({
            "success": True,
            "session_id": frame.session_id,
            "receipt": frame.receipt,
            "timestamp": frame.timestamp,
            "architect": frame.architect,
            "guardian": frame.guardian,
            "witness": frame.witness,
            "divergence_detected": frame.divergence_detected,
            "divergence_pattern": frame.divergence_pattern,
            "consistency": frame.consistency,
            "human_action": frame.human_action,
            "options": frame.options
        })
    except Exception as e:
        return jsonify({
            "success": False,
            "error": str(e),
            "human_action": "ERROR"
        }), 500


@app.route('/')
def index():
    return render_template_string(BABEL_HTML)

# Using raw string (r-prefix) for JavaScript regex patterns
BABEL_HTML = r'''<!DOCTYPE html><html lang="de"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1.0"><title>A4 Desk BABEL v4.7-gov</title><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"><link rel="stylesheet" href="/static/windi_v47.css"><link rel="stylesheet" href="/static/windi_v47.css"><style>*{margin:0;padding:0;box-sizing:border-box}:root{--primary:#1a365d;--accent:#3182ce;--success:#38a169;--warning:#d69e2e;--danger:#e53e3e;--bg:#f7fafc;--card:#fff;--text:#2d3748;--border:#e2e8f0}body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);min-height:100vh}.login-overlay{position:fixed;inset:0;background:linear-gradient(135deg,#1a365d,#2c5282);display:flex;align-items:center;justify-content:center;z-index:10000}.login-modal{background:#fff;border-radius:16px;padding:40px;max-width:500px;width:95%;max-height:90vh;overflow-y:auto}.login-header{text-align:center;margin-bottom:25px}.login-header .icon{font-size:56px}.login-header h1{color:var(--primary);font-size:1.6rem}.form-section{background:#f8fafc;border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px}.form-section-title{display:flex;align-items:center;gap:8px;font-weight:600;color:var(--primary);margin-bottom:12px}.form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}.form-row.single{grid-template-columns:1fr}.form-field{display:flex;flex-direction:column;gap:4px}.form-field label{font-size:.8rem;font-weight:600}.form-field .required{color:#dc2626}.form-field input,.form-field select{padding:10px;border:2px solid var(--border);border-radius:6px}.form-field input:focus{outline:none;border-color:var(--accent)}.form-field small{font-size:.7rem;color:#718096}.login-btn{width:100%;padding:14px;background:linear-gradient(135deg,#0d9488,#059669);color:#fff;border:none;border-radius:10px;cursor:pointer;font-weight:700;font-size:1rem;margin-top:10px}.login-principle{background:#f0fdf4;border:1px dashed #059669;padding:12px;border-radius:8px;text-align:center;margin-top:15px;font-size:.85rem;color:#065f46;font-weight:600}.migration-notice{background:#fef3c7;border:1px solid #f59e0b;border-radius:8px;padding:12px;margin-bottom:15px;font-size:.85rem;color:#92400e}.session-bar{position:fixed;top:0;left:0;right:0;height:40px;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:space-between;padding:0 20px;z-index:9000;font-size:.85rem}.session-bar .user-info{display:flex;align-items:center;gap:15px}.session-bar .btn-profile{background:transparent;border:1px solid rgba(255,255,255,0.3);color:#fff;padding:4px 12px;border-radius:4px;cursor:pointer;font-size:.8rem}.session-bar .btn-profile:hover{background:rgba(255,255,255,0.1)}.session-bar .timer.warning{color:#fbbf24;animation:pulse 1s infinite}.session-bar .btn-logout{background:var(--danger);border:none;color:#fff;padding:5px 15px;border-radius:4px;cursor:pointer}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}.app-content{margin-top:40px;display:flex;min-height:calc(100vh - 40px)}.sidebar{width:280px;background:var(--primary);color:#fff;padding:20px;flex-shrink:0}.sidebar.collapsed{width:0;padding:0;overflow:hidden}.sidebar-toggle{position:fixed;left:10px;top:50px;z-index:1000;background:var(--primary);color:#fff;border:none;width:40px;height:40px;border-radius:8px;cursor:pointer}.logo{display:flex;align-items:center;gap:10px;margin:30px 0 20px}.logo i{font-size:2rem;color:var(--accent)}.lang-bar{display:flex;gap:5px;margin-bottom:20px}.lang-btn{background:#2c5282;border:none;color:#fff;padding:5px 10px;border-radius:4px;cursor:pointer}.lang-btn.active{background:var(--accent)}.btn-new{width:100%;padding:12px;background:var(--success);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600;margin-bottom:20px}.doc-list{max-height:calc(100vh - 350px);overflow-y:auto}.doc-item{padding:12px;background:#2c5282;border-radius:6px;margin-bottom:8px;cursor:pointer;font-size:.85rem;display:flex;justify-content:space-between}.doc-item:hover{background:var(--accent)}.doc-item-delete{background:var(--danger);color:#fff;border:none;padding:4px 8px;border-radius:4px;cursor:pointer}.main-area{flex:1;display:flex;flex-direction:column}.top-bar{background:var(--card);padding:10px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:15px;flex-wrap:wrap}.top-bar-title{font-size:1.1rem;font-weight:600;color:var(--primary);margin-left:50px}.top-bar-actions{display:flex;gap:8px;margin-left:auto}.top-bar-btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:.85rem}.btn-save{background:var(--primary);color:#fff}.btn-finalize{background:var(--success);color:#fff}.btn-delete{background:var(--danger);color:#fff}.btn-settings{background:var(--accent);color:#fff}.status-badge{padding:6px 12px;border-radius:20px;font-size:.8rem;font-weight:600}.status-draft{background:#fef3c7;color:#92400e}.status-validated{background:#d1fae5;color:#065f46}.status-finalized{background:#dbeafe;color:#1e40af}.content-area{flex:1;display:flex;overflow:hidden}.editor-section{flex:1;display:flex;flex-direction:column;padding:20px;overflow-y:auto}.title-input{width:100%;font-size:1.5rem;font-weight:700;border:none;border-bottom:2px solid var(--border);padding:10px 0;margin-bottom:15px;color:var(--primary);background:transparent}.title-input:focus{outline:none;border-color:var(--accent)}.editor-toolbar{display:flex;gap:5px;padding:10px;background:var(--bg);border-radius:8px;margin-bottom:10px}.toolbar-btn{background:#fff;border:1px solid var(--border);padding:8px 12px;border-radius:4px;cursor:pointer}.toolbar-btn:hover{background:var(--accent);color:#fff}#editor{flex:1;border:1px solid var(--border);border-radius:8px;padding:20px;font-size:1rem;line-height:1.8;background:#fff;overflow-y:auto;min-height:200px}#editor:focus{outline:none;border-color:var(--accent)}.chat-section{width:40%;min-width:320px;display:flex;flex-direction:column;border-left:1px solid var(--border)}.chat-header{padding:15px;background:var(--primary);color:#fff}.chat-messages{flex:1;overflow-y:auto;padding:20px;background:var(--bg)}.chat-msg{padding:12px;border-radius:12px;margin-bottom:12px;max-width:90%;white-space:pre-wrap}.chat-user{background:var(--primary);color:#fff;margin-left:auto}.chat-ai{background:#fff;border:1px solid var(--border)}.insert-btn{margin-top:10px;padding:8px 16px;background:var(--success);color:#fff;border:none;border-radius:6px;cursor:pointer}.preview-btn{margin-top:10px;margin-right:8px;padding:8px 16px;background:var(--accent);color:#fff;border:none;border-radius:6px;cursor:pointer}.chat-input-area{padding:15px;background:#fff;border-top:1px solid var(--border)}.chat-textarea{width:100%;min-height:80px;padding:12px;border:1px solid var(--border);border-radius:8px;resize:vertical;margin-bottom:10px}.chat-actions{display:flex;gap:10px;justify-content:flex-end}.chat-send{padding:10px 20px;background:var(--accent);color:#fff;border:none;border-radius:8px;cursor:pointer;font-weight:600}.chat-send-doc{padding:10px 20px;background:var(--warning);color:#fff;border:none;border-radius:8px;cursor:pointer}.settings-panel{width:340px;background:var(--card);border-left:1px solid var(--border);padding:20px;overflow-y:auto}.settings-panel.collapsed{width:0;padding:0;overflow:hidden}.panel-toggle{position:fixed;right:10px;top:50px;z-index:1000;background:var(--accent);color:#fff;border:none;width:40px;height:40px;border-radius:8px;cursor:pointer}.panel-section{margin-bottom:25px}.panel-title{font-size:.9rem;font-weight:600;color:var(--primary);margin-bottom:10px}.human-field{margin-bottom:15px}.human-field label{display:block;font-size:.85rem;color:#718096;margin-bottom:5px}.human-field input,.human-field select{width:100%;padding:10px;border:1px solid var(--border);border-radius:6px}.human-field input:read-only{background:#f1f5f9}.human-field small{color:var(--warning);font-size:.75rem}.witness-section{background:#fefce8;border:1px dashed #eab308;border-radius:8px;padding:15px;margin-top:15px}.export-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}.btn-export{background:#805ad5;color:#fff;padding:8px;border:none;border-radius:6px;cursor:pointer}.receipt-box{background:var(--bg);border:1px solid var(--success);border-radius:8px;padding:15px;font-family:monospace;font-size:.75rem;display:none;margin-top:15px}.receipt-box.show{display:block}.panel-section:first-child{position:sticky;top:0;background:var(--card);z-index:10;padding-bottom:10px;border-bottom:1px solid var(--border)}.witness-section{position:sticky;top:160px;background:#fefce8;z-index:9}.chat-content{white-space:pre-wrap}.chat-content.collapsed{max-height:150px;overflow:hidden;position:relative}.chat-content.collapsed::after{content:'';position:absolute;bottom:0;left:0;right:0;height:40px;background:linear-gradient(transparent,#fff)}.expand-btn{background:transparent;border:1px dashed var(--accent);color:var(--accent);padding:4px 12px;border-radius:4px;cursor:pointer;margin:8px 0;display:block;width:100%;text-align:center}.reauth-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:10001}.reauth-overlay.show{display:flex}.reauth-modal{background:#fff;border-radius:16px;padding:30px;max-width:400px;width:95%}.reauth-modal h3{color:var(--primary);margin-bottom:10px}.reauth-modal input{width:100%;padding:12px;border:2px solid var(--border);border-radius:8px;margin-bottom:15px}.reauth-buttons{display:flex;gap:10px}.reauth-buttons button{flex:1;padding:12px;border:none;border-radius:8px;cursor:pointer;font-weight:600}.btn-reauth-confirm{background:var(--success);color:#fff}.btn-reauth-cancel{background:#718096;color:#fff}.profile-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:10001}.profile-overlay.show{display:flex}.profile-modal{background:#fff;border-radius:16px;padding:30px;max-width:500px;width:95%;max-height:90vh;overflow-y:auto}.profile-modal h3{color:var(--primary);margin-bottom:20px;display:flex;align-items:center;gap:10px}.profile-form .form-field{margin-bottom:15px}.profile-form label{display:block;font-size:.85rem;font-weight:600;color:#4a5568;margin-bottom:5px}.profile-form input{width:100%;padding:12px;border:2px solid var(--border);border-radius:8px}.profile-form input:read-only{background:#f1f5f9;color:#718096}.profile-form input:focus{outline:none;border-color:var(--accent)}.profile-buttons{display:flex;gap:10px;margin-top:20px}.profile-buttons button{flex:1;padding:12px;border:none;border-radius:8px;cursor:pointer;font-weight:600}.btn-profile-save{background:var(--success);color:#fff}.btn-profile-cancel{background:#718096;color:#fff}.preview-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:10001}.preview-overlay.show{display:flex}.preview-modal{background:#fff;border-radius:16px;padding:30px;max-width:800px;width:95%;max-height:90vh;overflow-y:auto}.preview-modal h3{color:var(--primary);margin-bottom:20px;display:flex;align-items:center;gap:10px}.preview-content{background:#f8fafc;border:1px solid var(--border);border-radius:8px;padding:20px;min-height:200px;max-height:400px;overflow-y:auto;white-space:pre-wrap;line-height:1.8}.preview-buttons{display:flex;gap:10px;margin-top:20px}.preview-buttons button{flex:1;padding:12px;border:none;border-radius:8px;cursor:pointer;font-weight:600}.btn-preview-insert{background:var(--success);color:#fff}.btn-preview-cancel{background:#718096;color:#fff}.toast{position:fixed;bottom:20px;right:20px;padding:15px 25px;border-radius:8px;color:#fff;font-weight:600;z-index:10002}.toast-success{background:var(--success)}.toast-error{background:var(--danger)}.toast-warning{background:var(--warning)}.template-overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);display:none;align-items:center;justify-content:center;z-index:10001}.template-overlay.show{display:flex}.template-modal{background:#fff;border-radius:16px;padding:30px;max-width:700px;width:95%;max-height:90vh;overflow-y:auto}.template-modal h3{color:var(--primary);margin-bottom:20px}.template-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:15px}.template-card{border:2px solid var(--border);border-radius:12px;padding:15px;cursor:pointer;transition:all .2s}.template-card:hover{border-color:var(--accent);transform:translateY(-2px)}.template-card.selected{border-color:var(--success);background:#f0fdf4}.template-card-header{height:40px;border-radius:6px;margin-bottom:10px}.template-card-name{font-weight:600;font-size:.9rem;margin-bottom:5px}.template-card-desc{font-size:.75rem;color:#718096}.template-card-langs{display:flex;gap:4px;margin-top:8px;flex-wrap:wrap}.template-card-lang{font-size:.65rem;background:#e2e8f0;padding:2px 6px;border-radius:4px}.template-buttons{display:flex;gap:10px;margin-top:20px}.template-buttons button{flex:1;padding:12px;border:none;border-radius:8px;cursor:pointer;font-weight:600}.btn-template-apply{background:var(--success);color:#fff}.btn-template-cancel{background:#718096;color:#fff}@media(max-width:900px){.content-area{flex-direction:column}.chat-section{width:100%;border-left:none;border-top:1px solid var(--border)}.form-row{grid-template-columns:1fr}}</style></head><body>

<div class="login-overlay" id="loginOverlay"><div class="login-modal"><div class="login-header"><div class="icon">🏛️</div><h1>WINDI Publishing House</h1><p>Human Identity Card</p></div><div class="migration-notice" id="migrationNotice" style="display:none"><strong>ℹ️ System aktualisiert.</strong> Zur Nutzung ergänzen Sie Ihre Mitarbeiter-ID und Passwort.</div><form onsubmit="handleLogin(event)"><div class="form-section"><div class="form-section-title"><i class="fas fa-user"></i> Persönliche Daten</div><div class="form-row"><div class="form-field"><label>Name <span class="required">*</span></label><input type="text" id="loginFullName" required placeholder="Max Mustermann"></div><div class="form-field"><label>Mitarbeiter-ID <span class="required">*</span></label><input type="text" id="loginEmployeeId" required placeholder="EMP-2024-0042"></div></div><div class="form-row"><div class="form-field"><label>Abteilung</label><input type="text" id="loginDepartment" placeholder="Bauamt"></div><div class="form-field"><label>Position</label><input type="text" id="loginPosition" placeholder="Sachbearbeiter"></div></div><div class="form-row single"><div class="form-field"><label>E-Mail</label><input type="email" id="loginEmail" placeholder="max@behoerde.de"></div></div><div class="form-row single"><div class="form-field"><label>Passwort <span class="required">*</span></label><input type="password" id="loginPassword" required placeholder="Ihr Passwort"><small>Bei Erstanmeldung wird dieses Passwort gespeichert.</small></div></div></div><div class="form-section"><div class="form-section-title"><i class="fas fa-sitemap"></i> Hierarchie (optional)</div><div class="form-row"><div class="form-field"><label>Vorgesetzter-ID</label><input type="text" id="loginSupervisorId" placeholder="EMP-2024-0001"></div><div class="form-field"><label>Vorgesetzter Name</label><input type="text" id="loginSupervisorName" placeholder="Dr. Schmidt"></div></div></div><button type="submit" class="login-btn"><i class="fas fa-sign-in-alt"></i> Anmelden</button><div class="login-principle">🔒 KI verarbeitet. Mensch entscheidet. WINDI garantiert.</div></form></div></div>

<div class="reauth-overlay" id="reauthOverlay"><div class="reauth-modal"><h3><i class="fas fa-shield-alt"></i> Re-Authentifizierung</h3><p>Passwort bestätigen:</p><input type="password" id="reauthPassword" placeholder="Passwort"><div class="reauth-buttons"><button class="btn-reauth-cancel" onclick="hideReauth()">Abbrechen</button><button class="btn-reauth-confirm" onclick="confirmReauth()">Bestätigen</button></div></div></div>

<!-- v4.7-gov: Profile Modal -->
<div class="profile-overlay" id="profileOverlay"><div class="profile-modal"><h3><i class="fas fa-user-edit"></i> Mein Profil</h3><div class="profile-form"><div class="form-field"><label>Name</label><input type="text" id="profileFullName" readonly></div><div class="form-field"><label>Mitarbeiter-ID</label><input type="text" id="profileEmployeeId" readonly></div><div class="form-field"><label>Abteilung</label><input type="text" id="profileDepartment" placeholder="Abteilung eingeben..."></div><div class="form-field"><label>Position</label><input type="text" id="profilePosition" placeholder="Position eingeben..."></div><div class="form-field"><label>E-Mail</label><input type="email" id="profileEmail" placeholder="email@beispiel.de"></div><div class="form-field"><label>Vorgesetzter-ID</label><input type="text" id="profileSupervisorId" placeholder="EMP-..."></div><div class="form-field"><label>Vorgesetzter Name</label><input type="text" id="profileSupervisorName" placeholder="Name des Vorgesetzten"></div></div><div class="profile-buttons"><button class="btn-profile-cancel" onclick="hideProfile()">Abbrechen</button><button class="btn-profile-save" onclick="saveProfile()"><i class="fas fa-save"></i> Speichern</button></div></div></div>

<!-- v4.7-gov: Preview Modal -->
<div class="preview-overlay" id="previewOverlay"><div class="preview-modal"><h3><i class="fas fa-eye"></i> Vorschau</h3><div class="preview-content" id="previewContent"></div><div class="preview-buttons"><button class="btn-preview-cancel" onclick="hidePreview()">Abbrechen</button><button class="btn-preview-insert" onclick="confirmInsert()"><i class="fas fa-plus"></i> Einfügen</button></div></div></div>

<div class="template-overlay" id="templateOverlay"><div class="template-modal"><h3><i class="fas fa-file-alt"></i> Template auswählen</h3><div class="template-grid" id="templateGrid"><div style="text-align:center;padding:20px"><i class="fas fa-spinner fa-spin"></i> Laden...</div></div><div class="template-buttons"><button class="btn-template-cancel" onclick="hideTemplateModal()">Abbrechen</button><button class="btn-template-apply" onclick="applySelectedTemplate()"><i class="fas fa-check"></i> Anwenden</button></div></div></div><div class="session-bar" id="sessionBar" style="display:none"><div class="user-info"><span><i class="fas fa-user-circle"></i> <span id="sessionUserName">-</span> | <span id="sessionUserId">-</span></span><button class="btn-profile" onclick="showProfile()"><i class="fas fa-user-edit"></i> Mein Profil</button></div><div class="timer" id="sessionTimer"><i class="fas fa-clock"></i> <span id="sessionTimeLeft">10:00</span></div><button class="btn-logout" onclick="handleLogout()"><i class="fas fa-sign-out-alt"></i> Abmelden</button></div>

<div class="app-content" id="appContent" style="display:none"><button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button><aside class="sidebar" id="sidebar"><div class="logo"><i class="fas fa-landmark"></i><div><h1>A4 Desk BABEL</h1><small>v4.7-gov</small></div></div><div class="lang-bar" id="langBar"></div><button class="btn-new" onclick="newDoc()"><i class="fas fa-plus"></i> Neues Dokument</button><div class="doc-list" id="docList"></div></aside><div class="main-area"><div class="top-bar"><span class="top-bar-title">A4 Desk BABEL v4.7-gov</span><div id="statusBadge" class="status-badge status-draft">Entwurf</div><div class="top-bar-actions"><button class="top-bar-btn btn-save" onclick="saveDoc()"><i class="fas fa-save"></i> Speichern</button><button class="top-bar-btn btn-finalize" onclick="finalizeDoc()"><i class="fas fa-check"></i> Abschließen</button><button class="top-bar-btn btn-delete" onclick="deleteCurrentDoc()"><i class="fas fa-trash"></i></button><button class="top-bar-btn btn-settings" onclick="togglePanel()"><i class="fas fa-cog"></i></button></div></div><div class="content-area"><div class="editor-section"><input type="text" class="title-input" id="docTitle" placeholder="Neues Dokument"><div class="editor-toolbar"><button class="toolbar-btn" onclick="execCmd('bold')"><i class="fas fa-bold"></i></button><button class="toolbar-btn" onclick="execCmd('italic')"><i class="fas fa-italic"></i></button><button class="toolbar-btn" onclick="execCmd('underline')"><i class="fas fa-underline"></i></button><button class="toolbar-btn" onclick="showTemplateModal()" title="Template"><i class="fas fa-file-alt"></i></button><button class="toolbar-btn" onclick="execCmd('insertUnorderedList')"><i class="fas fa-list-ul"></i></button><button class="toolbar-btn" onclick="execCmd('insertOrderedList')"><i class="fas fa-list-ol"></i></button></div><div id="editor" contenteditable="true"></div></div><div class="chat-section"><div class="chat-header"><i class="fas fa-dragon"></i> WINDI LLM Chat</div><div class="chat-messages" id="chatMessages"><div class="chat-msg chat-ai">Willkommen! Wie kann ich helfen?</div></div><div class="chat-input-area"><textarea class="chat-textarea" id="chatInput" placeholder="Nachricht..."></textarea><div class="chat-actions"><button class="chat-send-doc" onclick="sendDocToChat()"><i class="fas fa-file-export"></i> Doc→Chat</button><button class="chat-send" onclick="sendChat()"><i class="fas fa-paper-plane"></i> Senden</button></div></div></div></div></div><aside class="settings-panel collapsed" id="settingsPanel"><div class="panel-section"><div class="panel-title"><i class="fas fa-user"></i> Autor</div><div class="human-field"><label>Name</label><input type="text" id="fieldAuthorName" readonly></div><div class="human-field"><label>ID</label><input type="text" id="fieldAuthorId" readonly></div><div class="human-field"><label>Datum</label><input type="date" id="fieldDate"><small>🔒 Nur Mensch</small></div></div><div class="witness-section"><div class="panel-title" style="color:#854d0e"><i class="fas fa-eye"></i> Prüfer</div><div class="human-field"><label>Name *</label><input type="text" id="fieldWitnessName" placeholder="Name eingeben..." list="witnessList" onchange="fillWitnessData(this.value)"><datalist id="witnessList"></datalist><small>🔒 Erforderlich</small></div><div class="human-field"><label>ID</label><input type="text" id="fieldWitnessId" placeholder="ID eingeben..."></div><div class="human-field"><label>Position</label><input type="text" id="fieldWitnessPosition" placeholder="Position eingeben..."></div><div class="human-field"><label>Beziehung</label><select id="fieldWitnessRelation"><option value="">-- Auswählen --</option><option value="supervisor">Vorgesetzter</option><option value="compliance">Compliance</option><option value="peer">Peer</option><option value="external">Extern</option></select></div></div><div class="panel-section"><div class="panel-title"><i class="fas fa-file-export"></i> Export</div><div class="export-grid"><button class="btn-export" onclick="exportDoc('odt')">ODT</button><button class="btn-export" onclick="exportDoc('docx')">DOCX</button><button class="btn-export" onclick="exportDoc('pdf')">PDF</button><button class="btn-export" onclick="exportDoc('html')">HTML</button><button class="btn-export" onclick="exportDoc('rtf')">RTF</button><button class="btn-export" onclick="exportDoc('md')">MD</button></div></div><div class="receipt-box" id="receiptBox"></div></aside><button class="panel-toggle" onclick="togglePanel()"><i class="fas fa-cog"></i></button></div>

<script>
const CONFIG={sessionTimeoutMinutes:10,warningTimeSeconds:60};
const LANGS={de:{flag:'🇩🇪'},en:{flag:'🇬🇧'},pt:{flag:'🇧🇷'}};
const T={de:{draft:'Entwurf',validated:'Validiert',finalized:'Abgeschlossen',witness_required:'Prüfer erforderlich'},en:{draft:'Draft',validated:'Validated',finalized:'Finalized',witness_required:'Witness required'},pt:{draft:'Rascunho',validated:'Validado',finalized:'Finalizado',witness_required:'Testemunha necessária'}};
let currentLang='de',docId=null,sessionId=null,sessionTimer=null,sessionTimeLeft=CONFIG.sessionTimeoutMinutes*60,currentUser=null,pendingAction=null,legacyUserId=null,registeredUsers=[];

function t(k){return(T[currentLang]||T.de)[k]||k}

function checkLegacyData(){
    const oldHuman=localStorage.getItem('windi_human');
    const oldUserId=localStorage.getItem('windi_user_id');
    if(oldHuman||oldUserId){
        legacyUserId=oldUserId;
        document.getElementById('migrationNotice').style.display='block';
        if(oldHuman){try{const p=JSON.parse(oldHuman);document.getElementById('loginFullName').value=p.name||'';document.getElementById('loginDepartment').value=p.dept||'';document.getElementById('loginPosition').value=p.role||''}catch(e){}}
    }
}

function resetSessionTimer(){sessionTimeLeft=CONFIG.sessionTimeoutMinutes*60;updateTimerDisplay()}
function updateTimerDisplay(){const m=Math.floor(sessionTimeLeft/60),s=sessionTimeLeft%60;document.getElementById('sessionTimeLeft').textContent=m+':'+(s<10?'0':'')+s;document.getElementById('sessionTimer').classList.toggle('warning',sessionTimeLeft<=CONFIG.warningTimeSeconds)}
function startSessionTimer(){if(sessionTimer)clearInterval(sessionTimer);sessionTimer=setInterval(function(){sessionTimeLeft--;updateTimerDisplay();if(sessionTimeLeft<=0)handleSessionExpired()},1000)}
function handleSessionExpired(){clearInterval(sessionTimer);sessionId=null;currentUser=null;toast('Sitzung abgelaufen','warning');showLogin()}
['mousedown','keydown','scroll','touchstart'].forEach(function(e){document.addEventListener(e,function(){if(sessionId)resetSessionTimer()})});

function showLogin(){document.getElementById('loginOverlay').style.display='flex';document.getElementById('appContent').style.display='none';document.getElementById('sessionBar').style.display='none'}

function showApp(){
    document.getElementById('loginOverlay').style.display='none';
    document.getElementById('appContent').style.display='flex';
    document.getElementById('sessionBar').style.display='flex';
    document.getElementById('sessionUserName').textContent=currentUser.full_name;
    document.getElementById('sessionUserId').textContent=currentUser.employee_id;
    document.getElementById('fieldAuthorName').value=currentUser.full_name;
    document.getElementById('fieldAuthorId').value=currentUser.employee_id;
    document.getElementById('fieldDate').value=new Date().toISOString().split('T')[0];
}

async function handleLogin(e){
    e.preventDefault();
    const data={full_name:document.getElementById('loginFullName').value,employee_id:document.getElementById('loginEmployeeId').value,department:document.getElementById('loginDepartment').value,position:document.getElementById('loginPosition').value,email:document.getElementById('loginEmail').value,password:document.getElementById('loginPassword').value,supervisor_id:document.getElementById('loginSupervisorId').value,supervisor_name:document.getElementById('loginSupervisorName').value};
    try{
        const res=await fetch('/api/auth/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
        const result=await res.json();
        if(res.ok&&result.success){
            sessionId=result.session_id;
            currentUser=result.user;
            if(legacyUserId&&legacyUserId!==currentUser.employee_id){await migrateOldDocuments(legacyUserId,currentUser.employee_id,currentUser.full_name)}
            showApp();startSessionTimer();loadDocs();newDoc();toast('Anmeldung erfolgreich','success');loadWitnessList()
        }else{toast(result.error||'Fehler','error')}
    }catch(err){toast('Verbindungsfehler','error')}
}

async function migrateOldDocuments(oldId,newId,userName){
    try{
        const res=await fetch('/api/migrate/claim-documents',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({old_user_id:oldId,new_employee_id:newId,new_user_name:userName})});
        const result=await res.json();
        if(result.migrated>0){toast(result.migrated+' Dokumente migriert','success');localStorage.removeItem('windi_user_id');localStorage.removeItem('windi_human')}
    }catch(e){}
}

async function handleLogout(){
    if(sessionId)try{await fetch('/api/auth/logout',{method:'POST',headers:{'X-Session-ID':sessionId}})}catch(e){}
    clearInterval(sessionTimer);sessionId=null;currentUser=null;showLogin();toast('Abgemeldet','success')
}

function showReauth(action,cb){pendingAction={action:action,callback:cb};document.getElementById('reauthPassword').value='';document.getElementById('reauthOverlay').classList.add('show');document.getElementById('reauthPassword').focus()}
function hideReauth(){pendingAction=null;document.getElementById('reauthOverlay').classList.remove('show')}

async function confirmReauth(){
    const pw=document.getElementById('reauthPassword').value;
    if(!pw)return toast('Passwort erforderlich','error');
    try{
        const res=await fetch('/api/auth/reauth',{method:'POST',headers:{'Content-Type':'application/json','X-Session-ID':sessionId},body:JSON.stringify({password:pw,action:pendingAction?pendingAction.action:''})});
        if(res.ok){const cb=pendingAction?pendingAction.callback:null;hideReauth();if(cb)cb()}
        else{const r=await res.json();toast(r.error||'Fehler','error')}
    }catch(e){toast('Fehler','error')}
}

// v4.7-gov: Profile Functions
async function showProfile(){
    try{
        const res=await fetch('/api/auth/profile',{headers:{'X-Session-ID':sessionId}});
        if(res.ok){
            const data=await res.json();
            document.getElementById('profileFullName').value=data.full_name||'';
            document.getElementById('profileEmployeeId').value=data.employee_id||'';
            document.getElementById('profileDepartment').value=data.department||'';
            document.getElementById('profilePosition').value=data.position||'';
            document.getElementById('profileEmail').value=data.email||'';
            document.getElementById('profileSupervisorId').value=data.supervisor_id||'';
            document.getElementById('profileSupervisorName').value=data.supervisor_name||'';
            document.getElementById('profileOverlay').classList.add('show');
        }else{toast('Fehler beim Laden','error')}
    }catch(e){toast('Verbindungsfehler','error')}
}

function hideProfile(){document.getElementById('profileOverlay').classList.remove('show')}

async function saveProfile(){
    const data={
        department:document.getElementById('profileDepartment').value,
        position:document.getElementById('profilePosition').value,
        email:document.getElementById('profileEmail').value,
        supervisor_id:document.getElementById('profileSupervisorId').value,
        supervisor_name:document.getElementById('profileSupervisorName').value
    };
    try{
        const res=await fetch('/api/auth/profile',{method:'PUT',headers:{'Content-Type':'application/json','X-Session-ID':sessionId},body:JSON.stringify(data)});
        if(res.ok){
            const result=await res.json();
            currentUser.department=data.department;
            currentUser.position=data.position;
            currentUser.email=data.email;
            hideProfile();
            toast('Profil gespeichert','success');
        }else{const r=await res.json();toast(r.error||'Fehler','error')}
    }catch(e){toast('Verbindungsfehler','error')}
}

// v4.7-gov: Preview Functions
function showPreview(){
    if(!window._lastLLM){toast('Keine Antwort zum Vorschauen','warning');return}
    document.getElementById('previewContent').innerHTML=window._lastLLM.split('\n').join('<br>');
    document.getElementById('previewOverlay').classList.add('show');
}

function hidePreview(){document.getElementById('previewOverlay').classList.remove('show')}

function confirmInsert(){
    if(window._lastLLM){
        var ed=document.getElementById('editor');var body=ed.querySelector('.body');if(body){body.innerHTML=window._lastLLM.split('\n').join('<br>')}else{ed.innerHTML=window._lastLLM.split('\n').join('<br>')};
        toast('Eingefuegt','success');
        window._lastLLM=null;
    }
    hidePreview();
}

async function loadWitnessList(){
    try{
        const res=await fetch('/api/users',{headers:{'X-Session-ID':sessionId}});
        if(res.ok){
            const data=await res.json();
            registeredUsers=data.users||[];
            const dl=document.getElementById('witnessList');
            dl.innerHTML=registeredUsers.filter(function(u){return u.employee_id!==currentUser.employee_id}).map(function(u){return '<option value="'+u.full_name+'" data-id="'+u.employee_id+'" data-pos="'+(u.position||'')+'">'}).join('');
        }
    }catch(e){}
}

function fillWitnessData(name){
    const user=registeredUsers.find(function(u){return u.full_name===name});
    if(user){
        document.getElementById('fieldWitnessId').value=user.employee_id||'';
        document.getElementById('fieldWitnessPosition').value=user.position||'';
    }
}

function getAuthorData(){return{id:currentUser?currentUser.employee_id:'',name:currentUser?currentUser.full_name:'',employee_id:currentUser?currentUser.employee_id:'',department:currentUser?currentUser.department:'',position:currentUser?currentUser.position:''}}
function getWitnessData(){return{name:document.getElementById('fieldWitnessName').value,id:document.getElementById('fieldWitnessId').value,position:document.getElementById('fieldWitnessPosition').value,relation:document.getElementById('fieldWitnessRelation').value}}

async function newDoc(){
    const res=await fetch('/api/document',{method:'POST',headers:{'Content-Type':'application/json','X-Session-ID':sessionId},body:JSON.stringify({language:currentLang,author_data:getAuthorData()})});
    const doc=await res.json();
    docId=doc.id;
    document.getElementById('docTitle').value=doc.title;
    document.getElementById('editor').innerHTML='';
    document.getElementById('fieldDate').value=new Date().toISOString().split('T')[0];
    ['fieldWitnessName','fieldWitnessId','fieldWitnessPosition'].forEach(function(id){document.getElementById(id).value=''});
    document.getElementById('fieldWitnessRelation').value='';
    updateStatus('draft');
    document.getElementById('receiptBox').classList.remove('show');
    loadDocs();
    toast('Erstellt','success');
}

async function saveDoc(){
    if(!docId)await newDoc();
    const content={text:document.getElementById('editor').innerText,html:document.getElementById('editor').innerHTML};
    const res=await fetch('/api/document/'+docId,{method:'PUT',headers:{'Content-Type':'application/json','X-Session-ID':sessionId},body:JSON.stringify({title:document.getElementById('docTitle').value,content:content,human_fields:{author:currentUser?currentUser.full_name:'',author_id:currentUser?currentUser.employee_id:'',date:document.getElementById('fieldDate').value,witness_name:getWitnessData().name,witness_id:getWitnessData().id},author_data:getAuthorData(),witness_data:getWitnessData()})});
    if(res.ok){updateStatus('validated');toast('Gespeichert','success');loadDocs()}
}

async function finalizeDoc(){
    if(!docId)return toast('Kein Dokument','error');
    const wd=getWitnessData();
    if(!wd.name){toast(t('witness_required'),'error');document.getElementById('settingsPanel').classList.remove('collapsed');document.getElementById('fieldWitnessName').focus();return}
    showReauth('FINALIZE',async function(){
        await saveDoc();
        const res=await fetch('/api/document/'+docId+'/finalize',{method:'POST',headers:{'Content-Type':'application/json','X-Session-ID':sessionId},body:JSON.stringify({author_data:getAuthorData(),witness_data:wd,language:currentLang})});
        const data=await res.json();
        if(data.receipt){
            updateStatus('finalized');
            const box=document.getElementById('receiptBox');
            box.innerHTML='<strong>'+data.receipt.receipt_id+'</strong><br>Hash: '+data.receipt.hash+'<br>Autor: '+(data.receipt.author?data.receipt.author.name:'-')+'<br>Pruefer: '+(data.receipt.witness?data.receipt.witness.name:'-');
            box.classList.add('show');
            toast('WINDI-QUITTUNG erstellt','success');
        }else if(data.error){toast(data.error,'error')}
    });
}

async function deleteCurrentDoc(){
    if(!docId)return;
    if(!confirm('Dokument loeschen?'))return;
    showReauth('DELETE',async function(){await fetch('/api/document/'+docId,{method:'DELETE',headers:{'X-Session-ID':sessionId}});loadDocs();newDoc();toast('Geloescht','success')});
}

async function loadDoc(id){
    const res=await fetch('/api/document/'+id,{headers:{'X-Session-ID':sessionId}});
    const doc=await res.json();
    docId=doc.id;
    document.getElementById('docTitle').value=doc.title;
    document.getElementById('editor').innerHTML=doc.content&&doc.content.html?doc.content.html:(doc.content&&doc.content.text?doc.content.text.split('\n').join('<br>'):'');
    document.getElementById('fieldDate').value=doc.human_fields?doc.human_fields.date||'':'';
    document.getElementById('fieldWitnessName').value=doc.human_fields?doc.human_fields.witness_name||'':'';
    document.getElementById('fieldWitnessId').value=doc.human_fields?doc.human_fields.witness_id||'':'';
    updateStatus(doc.status);
    if(doc.receipt){const box=document.getElementById('receiptBox');box.innerHTML='<strong>'+doc.receipt.receipt_id+'</strong><br>Hash: '+doc.receipt.hash;box.classList.add('show')}
    else{document.getElementById('receiptBox').classList.remove('show')}
}

async function loadDocs(){
    const res=await fetch('/api/documents',{headers:{'X-Session-ID':sessionId}});
    const data=await res.json();
    document.getElementById('docList').innerHTML=data.documents.map(function(d){return '<div class="doc-item"><span onclick="loadDoc(\''+d.id+'\')">'+(d.status==='finalized'?'✅':d.status==='validated'?'✓':'📝')+' '+d.title+'</span><button class="doc-item-delete" onclick="event.stopPropagation();deleteDocById(\''+d.id+'\')">✕</button></div>'}).join('');
}

async function deleteDocById(id){
    if(!confirm('Loeschen?'))return;
    const targetId=id;
    showReauth('DELETE',async function(){
        const res=await fetch('/api/document/'+targetId,{method:'DELETE',headers:{'X-Session-ID':sessionId}});
        if(res.ok){loadDocs();if(docId===targetId)newDoc();toast('Geloescht','success')}
        else{toast('Fehler beim Loeschen','error')}
    });
}

function exportDoc(fmt){if(!docId)return toast('Zuerst speichern','error');window.location.href='/api/document/'+docId+'/export/'+fmt}
function updateStatus(s){const b=document.getElementById('statusBadge');b.className='status-badge status-'+s;b.textContent=t(s)}
function execCmd(c,v){document.execCommand(c,false,v||null);document.getElementById('editor').focus()}

async function sendChat(){
    const input=document.getElementById('chatInput'),msg=input.value.trim();
    if(!msg)return;
    const box=document.getElementById('chatMessages');
    box.innerHTML+='<div class="chat-msg chat-user">'+msg.split('\n').join('<br>')+'</div>';
    input.value='';
    box.innerHTML+='<div class="chat-msg chat-ai" id="thinking"><i class="fas fa-spinner fa-spin"></i> ...</div>';
    box.scrollTop=box.scrollHeight;
    try{
        const res=await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json','X-Session-ID':sessionId},body:JSON.stringify({message:msg,context:document.getElementById('editor').innerText,dragon:'claude',lang:currentLang})});
        const data=await res.json();
        var thinking=document.getElementById('thinking');if(thinking)thinking.remove();
        if(data.response){
            const fullResp=data.response;
            const isLong=fullResp.length>500;
            const displayHtml=fullResp.split('\n').join('<br>');
            window._lastLLM=fullResp;
            box.innerHTML+='<div class="chat-msg chat-ai"><div class="chat-content'+(isLong?' collapsed':'')+'">'+displayHtml+'</div>'+(isLong?'<button class="expand-btn" onclick="toggleExpand(this)">Mehr anzeigen ▼</button>':'')+'<button class="preview-btn" onclick="showPreview()"><i class="fas fa-eye"></i> Vorschau</button><button class="insert-btn" onclick="confirmInsert()"><i class="fas fa-plus"></i> Einfuegen</button></div>';
        }
    }catch(e){var thinking=document.getElementById('thinking');if(thinking)thinking.remove();box.innerHTML+='<div class="chat-msg chat-ai" style="color:var(--danger)">Fehler</div>'}
    box.scrollTop=box.scrollHeight;
}

function sendDocToChat(){if(!docId)return toast('Kein Dokument','error');document.getElementById('chatInput').value='Bitte ueberarbeiten:';document.getElementById('chatInput').focus()}

function toggleExpand(btn){
    const content=btn.previousElementSibling;
    if(content.classList.contains('collapsed')){content.classList.remove('collapsed');btn.textContent='Weniger anzeigen ▲'}
    else{content.classList.add('collapsed');btn.textContent='Mehr anzeigen ▼'}
}

function toggleSidebar(){document.getElementById('sidebar').classList.toggle('collapsed')}
function togglePanel(){document.getElementById('settingsPanel').classList.toggle('collapsed')}
function setLang(l){currentLang=l;document.querySelectorAll('.lang-btn').forEach(function(b){b.classList.toggle('active',b.dataset.lang===l)})}
function initLangBar(){document.getElementById('langBar').innerHTML=Object.keys(LANGS).map(function(k){return '<button class="lang-btn '+(k===currentLang?'active':'')+'" data-lang="'+k+'" onclick="setLang(\''+k+'\')">'+LANGS[k].flag+'</button>'}).join('')}
function toast(m,t){var el=document.createElement('div');el.className='toast toast-'+t;el.textContent=m;document.body.appendChild(el);setTimeout(function(){el.remove()},3000)}

document.addEventListener('DOMContentLoaded',function(){
    document.getElementById('chatInput').addEventListener('keydown',function(e){if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendChat()}});
    document.getElementById('reauthPassword').addEventListener('keydown',function(e){if(e.key==='Enter'){e.preventDefault();confirmReauth()}});
});

function cleanLLMResponse(text){
    var lines=text.split('\n');
    var clean=[];
    var skip=['Human decides','WINDI Publishing','KI verarbeitet','EU AI Act','A4 Desk BABEL','Dokument wurde von menschlichen','human supervision'];
    for(var i=0;i<lines.length;i++){
        var dominated=false;
        for(var j=0;j<skip.length;j++){if(lines[i].indexOf(skip[j])>=0){dominated=true;break}}
        if(!dominated)clean.push(lines[i]);
    }
    return clean.join('\n').replace(/^[\s\-]*$/gm,'').replace(/\n{3,}/g,'\n\n');
}
let selectedTemplateId=null;async function loadTemplates(){try{const res=await fetch("/api/registry/templates/visual");const data=await res.json();const grid=document.getElementById("templateGrid");grid.innerHTML=data.templates.map(t=>'<div class="template-card" data-id="'+t.id+'" onclick="selectTemplate(this,\''+t.id+'\')"><div class="template-card-header" style="background:linear-gradient(135deg,'+t.colors.primary+','+(t.colors.secondary||t.colors.primary)+')"></div><div class="template-card-name">'+t.name+'</div><div class="template-card-desc">'+t.description+'</div><div class="template-card-langs">'+t.languages.map(l=>'<span class="template-card-lang">'+l.toUpperCase()+'</span>').join("")+'</div></div>').join("")}catch(e){document.getElementById("templateGrid").innerHTML="<p>Fehler beim Laden</p>"}}function selectTemplate(el,id){document.querySelectorAll(".template-card").forEach(c=>c.classList.remove("selected"));el.classList.add("selected");selectedTemplateId=id}async function applySelectedTemplate(){if(!selectedTemplateId)return toast("Bitte Template auswählen","warning");try{const res=await fetch("/api/registry/templates/visual/"+selectedTemplateId+"?lang="+currentLang);const data=await res.json();if(data.html){document.getElementById("editor").innerHTML=data.html;if(window.WINDI_TOOLBAR)window.WINDI_TOOLBAR.setCurrentTemplate(selectedTemplateId);toast("Template angewendet","success");hideTemplateModal()}}catch(e){toast("Fehler","error")}}function showTemplateModal(){document.getElementById("templateOverlay").classList.add("show");loadTemplates()}function hideTemplateModal(){document.getElementById("templateOverlay").classList.remove("show");selectedTemplateId=null}initLangBar();
checkLegacyData();
showLogin();
</script>
<script src="/static/extensions/institutional_blocks.js"></script>
<script src="/static/toolbar/institutional_toolbar.js"></script>
</body></html>'''

if __name__ == '__main__':
    print("🏛️ A4 Desk BABEL v4.7-gov")
    print("✅ NEW: Mein Profil - Edit your profile data")
    print("✅ NEW: Preview before Insert")
    print("✅ NEW: Human Authorship Notice in PDF")
    print("URL: http://0.0.0.0:8085")
    app.run(host='0.0.0.0', port=CONFIG["port"], debug=False)

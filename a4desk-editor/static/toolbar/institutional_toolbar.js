let currentTemplateId = null;
function getBlockIcon(blockId) { const icons = { betreff:'ğŸ“‹', bezug:'ğŸ”—', anrede:'ğŸ‘‹', haupttext:'ğŸ“', massnahmen:'âœ“', anlagen:'ğŸ“', grussformel:'âœ‰', executive_summary:'ğŸ“Š', risk_assessment:'âš ', compliance_measures:'âœ“', recommendations:'ğŸ’¡', memo_header:'ğŸ“„', memo_body:'ğŸ“', action_items:'â˜‘' }; return icons[blockId] || 'âŠ'; }
function buildBlockDropdown() { if (!currentTemplateId || !window.WINDI_BLOCKS) return ''; const blocks = window.WINDI_BLOCKS.getBlocksForTemplate(currentTemplateId); if (!blocks.length) return ''; let html = '<div class="windi-dropdown"><button class="toolbar-btn windi-dropdown-trigger" title="Block einfuegen"><i class="fas fa-cubes"></i> Block â–¾</button><div class="windi-dropdown-menu">'; blocks.forEach(block => { html += '<button class="windi-dropdown-item' + (block.required ? ' required' : '') + '" onclick="window.WINDI_BLOCKS.insertInstitutionalBlock(\'' + currentTemplateId + '\', \'' + block.id + '\')"><span class="block-icon">' + getBlockIcon(block.id) + '</span> ' + block.label + (block.required ? ' *' : '') + '</button>'; }); html += '</div></div>'; return html; }
function buildComplianceIndicator() { return '<div id="windiCompliance" class="windi-compliance" onclick="showComplianceDetails()" title="Document Structure"><span class="compliance-icon">â—¯</span><span class="compliance-label">Checking...</span></div>'; }
function updateComplianceIndicator() { const indicator = document.getElementById('windiCompliance'); if (!indicator) return; if (!currentTemplateId) { indicator.className = 'windi-compliance'; let icon = indicator.querySelector('.compliance-icon'); let label = indicator.querySelector('.compliance-label'); if(icon) icon.textContent = 'â—‹'; if(label) label.textContent = ''; return; } const result = window.WINDI_BLOCKS.validateDocumentStructure(currentTemplateId); const icon = indicator.querySelector('.compliance-icon'); const label = indicator.querySelector('.compliance-label'); if (result.valid) { indicator.className = 'windi-compliance valid'; icon.textContent = 'âœ“'; label.textContent = 'Konform'; } else { indicator.className = 'windi-compliance invalid'; icon.textContent = 'âœ—'; label.textContent = result.missing.length + ' missing'; } }
function showComplianceDetails() { if (!currentTemplateId) { return; } const result = window.WINDI_BLOCKS.validateDocumentStructure(currentTemplateId); if (result.valid) { alert('âœ“ Document is compliant\n\nAll required fields are present.'); } else { let msg = 'âœ— Missing required fields:\n\n'; result.missing.forEach(b => { msg += 'â€¢ ' + b.label + '\n'; }); alert(msg); } }
function injectInstitutionalToolbar() { const toolbar = document.querySelector('.editor-toolbar'); if (!toolbar) return; const listBtn = toolbar.querySelector('[onclick*="insertUnorderedList"]'); if (listBtn) { const dropdown = document.createElement('div'); dropdown.innerHTML = buildBlockDropdown(); if (dropdown.firstChild) { listBtn.parentNode.insertBefore(dropdown.firstChild, listBtn); } } const indicator = document.createElement('div'); indicator.innerHTML = buildComplianceIndicator(); if (indicator.firstChild) { toolbar.appendChild(indicator.firstChild); } const trigger = toolbar.querySelector('.windi-dropdown-trigger'); const menu = toolbar.querySelector('.windi-dropdown-menu'); if (trigger && menu) { trigger.addEventListener('click', (e) => { e.preventDefault(); menu.classList.toggle('show'); }); document.addEventListener('click', (e) => { if (!e.target.closest('.windi-dropdown')) menu.classList.remove('show'); }); } const editor = document.getElementById('editor'); if (editor) { const observer = new MutationObserver(() => { setTimeout(updateComplianceIndicator, 100); }); observer.observe(editor, { childList: true, subtree: true, characterData: true }); } setTimeout(updateComplianceIndicator, 500); }
function setCurrentTemplate(templateId) { currentTemplateId = templateId; updateComplianceIndicator(); }
window.WINDI_TOOLBAR = { injectInstitutionalToolbar, updateComplianceIndicator, setCurrentTemplate, currentTemplateId: () => currentTemplateId };
if (document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', () => setTimeout(injectInstitutionalToolbar, 100)); } else { setTimeout(injectInstitutionalToolbar, 100); }
console.log('[WINDI] Institutional Toolbar v4.7 loaded');


